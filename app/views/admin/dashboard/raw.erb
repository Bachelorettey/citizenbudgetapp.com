<%=
# Use Windows newline characters as row separator.
CSV.generate(:col_sep => @col_sep, :row_sep => "\r\n") do |csv|
  headers = @questionnaire.csv_headers.map do |column|
    Response.human_attribute_name column
  end
  @questionnaire.sections.each do |section|
    section.questions.each do |question|
      headers << question.title
    end
  end
  csv << headers

  defaults = @questionnaire.csv_headers.map do |column|
    t :default
  end
  @questionnaire.sections.each do |section|
    section.questions.each do |question|
      defaults << question.default_value || t(:default)
    end
  end
  csv << defaults

  @questionnaire.responses.each do |response|
    row = @questionnaire.csv_headers.map do |column|
      response.send column
    end
    @questionnaire.sections.each do |section|
      section.questions.each do |question|
        answer = response.answer(question)
        if Array === answer
          row << answer.join "\r\n"
        else
          row << answer
        end
      end
    end
    csv << row
  end
end.html_safe
%>
